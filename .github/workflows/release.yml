name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [
          "x86_64-linux-gnu",
          "aarch64-linux-gnu",
          "arm-linux-gnueabihf",
          "x86-linux-gnu",
          "riscv64-linux-gnu",
          "x86_64-linux-musl",
          "aarch64-linux-musl"
        ]
    steps:
      - uses: actions/checkout@v4
      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: master
      - name: Build (static-preferred)
        run: |
          T="${{ matrix.target }}"
          if [[ "$T" == *"linux-musl"* ]]; then
            zig build -Dtarget="$T" -Doptimize=ReleaseSafe -Dstatic=true
          else
            if zig build -Dtarget="$T" -Doptimize=ReleaseSafe -Dstatic=true; then
              echo "static link ok"
            else
              echo "fallback to dynamic"
              zig build -Dtarget="$T" -Doptimize=ReleaseSafe
            fi
          fi
      - name: Package
        run: |
          OUT="zigscan-${{ matrix.target }}"
          mv zig-out/bin/zigscan "$OUT"
          chmod +x "$OUT"
          tar czf "$OUT.tar.gz" "$OUT"
          sha256sum "$OUT.tar.gz" > "$OUT.tar.gz.sha256"
      - uses: actions/upload-artifact@v4
        with:
          name: zigscan-${{ matrix.target }}
          path: |
            zigscan-${{ matrix.target }}.tar.gz
            zigscan-${{ matrix.target }}.tar.gz.sha256

  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["x86_64-macos", "aarch64-macos"]
    steps:
      - uses: actions/checkout@v4
      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: master
      - name: Build
        run: zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe
      - name: Package
        run: |
          OUT="zigscan-${{ matrix.target }}"
          mv zig-out/bin/zigscan "$OUT"
          chmod +x "$OUT"
          tar czf "$OUT.tar.gz" "$OUT"
          shasum -a 256 "$OUT.tar.gz" > "$OUT.tar.gz.sha256"
      - uses: actions/upload-artifact@v4
        with:
          name: zigscan-${{ matrix.target }}
          path: |
            zigscan-${{ matrix.target }}.tar.gz
            zigscan-${{ matrix.target }}.tar.gz.sha256

  build-experimental:
    name: EXP Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        target: [
          "x86_64-windows",
          "aarch64-windows",
          "x86-windows",
          "loongarch64-linux-gnu",
          "mips-linux-musl",
          "mipsel-linux-musl",
          "mips64-linux-musl",
          "mips64el-linux-musl",
          "mips-linux-gnu",
          "mipsel-linux-gnu",
          "mips64-linux-gnu",
          "mips64el-linux-gnu",
          "powerpc64le-linux-gnu",
          "s390x-linux-gnu",
          "riscv32-linux-gnu",
          "riscv64-linux-musl",
          "arm-linux-musleabihf"
        ]
    steps:
      - uses: actions/checkout@v4
      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: master
      - name: Build (static-preferred)
        run: |
          T="${{ matrix.target }}"
          if [[ "$T" == *"linux-musl"* ]]; then
            zig build -Dtarget="$T" -Doptimize=ReleaseSafe -Dstatic=true || zig build -Dtarget="$T" -Doptimize=ReleaseSafe
          else
            zig build -Dtarget="$T" -Doptimize=ReleaseSafe -Dstatic=true || zig build -Dtarget="$T" -Doptimize=ReleaseSafe
          fi
      - name: Package
        run: |
          OUT="zigscan-${{ matrix.target }}"
          if [[ "${{ matrix.target }}" == *"-windows"* ]]; then
            mv zig-out/bin/zigscan.exe "$OUT.exe" || true
            powershell -Command "Compress-Archive -Path '$OUT.exe' -DestinationPath '$OUT.zip'" || true
          else
            mv zig-out/bin/zigscan "$OUT" || true
            chmod +x "$OUT" || true
            tar czf "$OUT.tar.gz" "$OUT" || true
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: zigscan-${{ matrix.target }}
          path: |
            zigscan-${{ matrix.target }}.tar.gz
            zigscan-${{ matrix.target }}.zip

  release:
    name: Create Release
    needs: [build-linux, build-macos, build-experimental]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - run: ls -R artifacts/
      - uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
